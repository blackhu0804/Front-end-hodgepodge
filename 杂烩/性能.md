# 性能

## 网络相关

### DNS 预解析

DNS解析是需要时间的，可以通过预解析的方式来预先获得域名所对应的IP；

```html
<link rel="dns-prefetch" href="//baidu.com">
```

### 缓存

缓存对于前端性能优化来说是一个很重要的部分，良好的缓存策略可以降低资源的重复加载提高网页的整体加载速度。

通常浏览器缓存策略分为两种：强缓存 和 协商缓存

#### 强缓存

可以通过两种响应头实现：`Expires` 和 `Cache-Control` 。强缓存在缓存期间不需要请求，HTTP返回 200

```javascript
Expires: Wed, 22 Oct 2018 08:41:00 GMT
```

`Expires` 出现于 HTTP /  1.0 ，表示资源会在 `Wed, 22 Oct 2018 08:41:00 GMT` 后过期，需要再次请求。并且受限于本地时间，如果修改了本地事件，如果修改了本地时间，可能造成缓存失效

```javascript
Cache-control: max-age = 30
```

`Cache-Control` 出现于 HTTP / 1.1， 优先级高于 `Expires` 。 该属性表示资源会在 30 秒后过期，需要再次请求。

#### 协商缓存

如果缓存过期了，我们可以采用协商缓存来解决问题。协商缓存需要请求，缓存有效返回 304；

协商缓存 需要客户端与服务端共同实现，有两种实现方式

##### Last-Modefied 和 If-Modefied-Since

`Last-Modified`  表示缓存的最后修改日期，`If-Modefied-Since` 会将 `Last-Modefied` 发送给服务器，判断该日期后资源是否有更新，有更新的话将新的资源发送回来。

但是该方法有一个缺点，如果在本地打开文件，就会造成 `Last-Modefied` 被修改。所以在HTTP 1.1 出现了 `ETag`。

#####Etag 和 If-None-Match

`Etag` 类似于文件指纹， `If-None-Match` 会将当前 `Etag` 发送给服务器，询问是否有变动，有变动就把新的资源发送过来。 

#### 选择合适的缓存策略

- 对于某些不需要缓存的资源，可以使用 `Cache-control: no-store`， 表示该资源不需要缓存。
- 对于频繁变动的资源，可以使用 `Cache-Control: no-cache` 并配合 `Etag` 使用，表示该资源已被缓存，但是每次都会发送请求询问资源是否更新。
- 对于代码文件来说，通常使用`Cache-Control: max-age=31536000` 并配合策略缓存使用。对文件进行指纹处理，一旦文件名变动就会立刻下载新的文件。

#### HTTP 2.0

在HTTP / 2.0 中引入多路复用，能够让多个请求使用同一个 TCP 链接。还支持 Header 压缩，进一步减少了请求的数据大小。

#### 预加载

在开发中，可能会遇到这样的情况。有些资源不需要马上用到，但是希望尽早获取，这时候就可以使用预加载。 

预加载其实是声明式 `fetch` ，强制浏览器请求资源，并且不会阻塞 `onload` 事件.预加载可以一定程度上降低首屏的加载时间，因为可以将一些不影响首屏但重要的文件延后加载，唯一缺点就是兼容性不好。 

```html
<link rel="preload" href="http://example.com">
```

#### 预渲染

可以通过预渲染将下载的文件预先在后台渲染，可以使用以下代码开启预渲染

```html
<link rel="prerender" href="http://example.com">
```

### 优化渲染过程

#### 懒执行

懒执行就是将某些逻辑延迟到使用时再计算。该技术可以用于首屏优化，对于某些耗时逻辑并不需要在首屏就使用的，就可以使用懒执行。懒执行需要唤醒，一般可以通过定时器或者事件的调用来唤醒。

#### 懒加载

懒加载就是将不关键的资源延后加载。

懒加载的原理就是只加载自定义区域（通常是可视区域，但也可以是即将进入可视区域）内需要加载的东西。对于图片来说，先设置图片标签的 `src` 属性为一张占位图，将真实的图片资源放入一个自定义属性中，当进入自定义区域时，就将自定义属性替换为 `src` 属性，这样图片就会去下载资源，实现了图片懒加载。

懒加载不仅可以用于图片，也可以使用在别的资源上。比如进入可视区域才开始播放视频等等。

### 文件优化

1. 可以用css 代替一些图片
2. 转为base64格式
3. 雪碧图
4. CSS 文件放在 `head` 中
5. 将script标签放在 body 底部，因为 JS 文件执行会阻塞渲染。当然也可以把 `script` 标签放在任意位置然后加上 `defer`，表示该文件会并行下载。
6. 对于需要很长时间计算的代码可以使用 `Webworker` 另开一个线程执行脚本而不影响渲染
7. 静态资源尽量使用 CDN 加载

### 如何渲染几万条数据不卡住

应该一次渲染部分 DOM，那么就可以通过 `requestAnimationFrame` 来每 16 ms 刷新一次。  